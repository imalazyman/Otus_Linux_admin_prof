[Unit]
Description=Borg Backup - Complete Cycle
After=network.target

[Service]
Type=oneshot
User=vagrant
RemainAfterExit=no

# Парольная фраза
Environment="BORG_PASSPHRASE=Otus1234"
# Репозиторий
Environment="REPO=borg@192.168.56.160:/var/backup/"
# Что бэкапим
Environment="BACKUP_TARGET=/etc"
# SSH ключ для аутентификации
Environment="BORG_RSH=ssh -i /home/vagrant/.ssh/borg_key -o StrictHostKeyChecking=no"

ExecStart=/bin/sh -c '\
  echo "$(date): Starting Borg backup process" | tee -a /var/log/borg-backup/backup.log | logger -t borg-backup && \
  borg create \
    --lock-wait 60 \
    --stats \
    ${REPO}::etc-{now:%%Y-%%m-%%d_%%H:%%M:%%S} ${BACKUP_TARGET} 2>&1 | tee -a /var/log/borg-backup/backup.log | logger -t borg-backup && \
  echo "$(date): Backup creation completed" | tee -a /var/log/borg-backup/backup.log | logger -t borg-backup'

ExecStartPost=/bin/sh -c '\
  echo "$(date): Starting repository check" | tee -a /var/log/borg-backup/backup.log | logger -t borg-backup && \
  borg check \
    --lock-wait 30 \
    ${REPO} 2>&1 | tee -a /var/log/borg-backup/backup.log | logger -t borg-backup && \
  echo "$(date): Repository check completed" | tee -a /var/log/borg-backup/backup.log | logger -t borg-backup'

ExecStartPost=/bin/sh -c '\
  echo "$(date): Starting prune operation" | tee -a /var/log/borg-backup/backup.log | logger -t borg-backup && \
  borg prune \
    --lock-wait 30 \
    --keep-daily 90 \
    --keep-monthly 12 \
    --keep-yearly 1 \
    ${REPO} 2>&1 | tee -a /var/log/borg-backup/backup.log | logger -t borg-backup && \
  echo "$(date): Prune operation completed" | tee -a /var/log/borg-backup/backup.log | logger -t borg-backup'